---
title: "å¸¦ Postgres çš„ API æœåŠ¡å™¨"
oldUrl:
  - /deploy/docs/tutorial-postgres/
  - /deploy/manual/tutorial-postgres/
---

Postgres æ˜¯ä¸€ä¸ªæµè¡Œçš„æ•°æ®åº“ï¼Œå› å…¶çµæ´»æ€§å’Œæ˜“ç”¨æ€§è€Œå¹¿å—æ¬¢è¿ã€‚æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•å°† Deno Deploy ä¸ Postgres ä¸€èµ·ä½¿ç”¨ã€‚

- [å¸¦ Postgres çš„ API æœåŠ¡å™¨](#å¸¦-postgres-çš„-api-æœåŠ¡å™¨)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [è®¾ç½® Postgres](#è®¾ç½®-postgres)
    - [Neon Postgres](#neon-postgres)
    - [Supabase](#supabase)
  - [ç¼–å†™å¹¶éƒ¨ç½²åº”ç”¨ç¨‹åº](#ç¼–å†™å¹¶éƒ¨ç½²åº”ç”¨ç¨‹åº)

## æ¦‚è¿°

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç®€å•å¾…åŠåˆ—è¡¨åº”ç”¨ç¨‹åºçš„ APIã€‚å®ƒå°†æœ‰ä¸¤ä¸ªç«¯ç‚¹ï¼š

`GET /todos` å°†è¿”å›æ‰€æœ‰å¾…åŠäº‹é¡¹çš„åˆ—è¡¨ï¼Œ`POST /todos` å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å¾…åŠäº‹é¡¹ã€‚

```
GET /todos
---
title: "è¿”å›æ‰€æœ‰å¾…åŠäº‹é¡¹çš„åˆ—è¡¨"
---
[
  {
    "id": 1,
    "title": "ä¹°é¢åŒ…"
  },
  {
    "id": 2,
    "title": "ä¹°å¤§ç±³"
  },
  {
    "id": 3,
    "title": "ä¹°é¦™æ–™"
  }
]

POST /todos
---
title: "åˆ›å»ºä¸€ä¸ªæ–°çš„å¾…åŠäº‹é¡¹"
---
"ä¹°ç‰›å¥¶"
---
title: "è¿”å› 201 çŠ¶æ€ç "
---
```

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ï¼š

- åœ¨ [Neon Postgres](https://neon.tech/) æˆ– [Supabase](https://supabase.com) ä¸Šåˆ›å»ºå’Œè®¾ç½®ä¸€ä¸ª [Postgres](https://www.postgresql.org/) å®ä¾‹ã€‚
- ä½¿ç”¨ [Deno Deploy](../manual/deployctl.md) Playground å¼€å‘å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºã€‚
- ä½¿ç”¨ [cURL](https://curl.se/) æµ‹è¯•æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

## è®¾ç½® Postgres

> æœ¬æ•™ç¨‹å°†å®Œå…¨ä¸“æ³¨äºä¸åŠ å¯†åœ°è¿æ¥åˆ° Postgresã€‚å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨è‡ªå®šä¹‰ CA è¯ä¹¦è¿›è¡ŒåŠ å¯†ï¼Œè¯·ä½¿ç”¨ [æ­¤å¤„](https://deno-postgres.com/#/?id=ssltls-connection) çš„æ–‡æ¡£ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ Postgres å®ä¾‹ä»¥è¿æ¥ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Neon Postgres](https://neon.tech/) æˆ– [Supabase](https://supabase.com)ï¼Œå› ä¸ºå®ƒä»¬éƒ½æä¾›å…è´¹çš„æ‰˜ç®¡ Postgres å®ä¾‹ã€‚å¦‚æœæ‚¨å¸Œæœ›å°†æ•°æ®åº“æ‰˜ç®¡åœ¨å…¶ä»–åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥è¿™æ ·åšã€‚

### Neon Postgres

1. è®¿é—® https://neon.tech/ å¹¶ç‚¹å‡» **æ³¨å†Œ** é€šè¿‡ç”µå­é‚®ä»¶ã€Githubã€Google æˆ–åˆä½œä¼™ä¼´å¸æˆ·æ³¨å†Œã€‚æ³¨å†Œåï¼Œæ‚¨å°†è¢«å¼•å¯¼åˆ° Neon æ§åˆ¶å°ä»¥åˆ›å»ºç¬¬ä¸€ä¸ªé¡¹ç›®ã€‚
2. è¾“å…¥é¡¹ç›®åç§°ï¼Œé€‰æ‹© Postgres ç‰ˆæœ¬ï¼Œæä¾›æ•°æ®åº“åç§°ï¼Œå¹¶é€‰æ‹©åŒºåŸŸã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ‚¨ä¼šå¸Œæœ›é€‰æ‹©ç¦»æ‚¨åº”ç”¨ç¨‹åºæœ€è¿‘çš„åŒºåŸŸã€‚å®Œæˆåï¼Œç‚¹å‡» **åˆ›å»ºé¡¹ç›®**ã€‚
3. æ‚¨å°†çœ‹åˆ°æ–°é¡¹ç›®çš„è¿æ¥å­—ç¬¦ä¸²ï¼Œæ‚¨å¯ä»¥ç”¨å®ƒè¿æ¥åˆ°æ•°æ®åº“ã€‚ä¿å­˜è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶æ ¼å¼ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š

   ```sh
   postgres://alex:AbC123dEf@ep-cool-darkness-123456.us-east-2.aws.neon.tech/dbname?sslmode=require
   ```

### Supabase

1. è®¿é—® https://app.supabase.io/ å¹¶ç‚¹å‡» "æ–°é¡¹ç›®"ã€‚
2. ä¸ºæ‚¨çš„æ•°æ®åº“é€‰æ‹©åç§°ã€å¯†ç å’ŒåŒºåŸŸã€‚åŠ¡å¿…ä¿å­˜å¯†ç ï¼Œå› ä¸ºæ‚¨ç¨åå°†éœ€è¦å®ƒã€‚
3. ç‚¹å‡» "åˆ›å»ºæ–°é¡¹ç›®"ã€‚åˆ›å»ºé¡¹ç›®å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
4. ä¸€æ—¦é¡¹ç›®åˆ›å»ºå®Œæˆï¼Œå¯¼èˆªåˆ°å·¦ä¾§çš„ "æ•°æ®åº“" é€‰é¡¹å¡ã€‚
5. è½¬åˆ° "è¿æ¥æ± " è®¾ç½®ï¼Œä» "è¿æ¥å­—ç¬¦ä¸²" å­—æ®µä¸­å¤åˆ¶è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™å°±æ˜¯æ‚¨å°†ç”¨äºè¿æ¥åˆ°æ•°æ®åº“çš„è¿æ¥å­—ç¬¦ä¸²ã€‚åœ¨æ­¤å­—ç¬¦ä¸²ä¸­æ’å…¥æ‚¨ä¹‹å‰ä¿å­˜çš„å¯†ç ï¼Œç„¶åå°†å…¶ä¿å­˜åœ¨æŸä¸ªåœ°æ–¹ - ç¨åæ‚¨å°†éœ€è¦å®ƒã€‚

## ç¼–å†™å¹¶éƒ¨ç½²åº”ç”¨ç¨‹åº

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™åº”ç”¨ç¨‹åºäº†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†åœ¨æ§åˆ¶é¢æ¿ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ Deno Deploy Playgroundï¼šåœ¨ https://dash.deno.com/projects ä¸ŠæŒ‰ä¸‹ "æ–° Playground" æŒ‰é’®ã€‚

è¿™å°†æ‰“å¼€ Playground ç¼–è¾‘å™¨ã€‚åœ¨æˆ‘ä»¬çœŸæ­£å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å°† Postgres è¿æ¥å­—ç¬¦ä¸²æ”¾å…¥ç¯å¢ƒå˜é‡ä¸­ã€‚ä¸ºæ­¤ï¼Œç‚¹å‡»ç¼–è¾‘å™¨å·¦ä¸Šè§’çš„é¡¹ç›®åç§°ã€‚è¿™å°†æ‰“å¼€é¡¹ç›®è®¾ç½®ã€‚

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥é€šè¿‡å·¦ä¾§å¯¼èˆªèœå•å¯¼èˆªåˆ° "è®¾ç½®" -> "ç¯å¢ƒå˜é‡" é€‰é¡¹å¡ã€‚åœ¨ "é”®" å­—æ®µä¸­è¾“å…¥ "DATABASE_URL"ï¼Œå¹¶å°†è¿æ¥å­—ç¬¦ä¸²ç²˜è´´åˆ° "å€¼" å­—æ®µä¸­ã€‚ç°åœ¨ï¼ŒæŒ‰ "æ·»åŠ "ã€‚æ‚¨çš„ç¯å¢ƒå˜é‡ç°åœ¨å·²è®¾ç½®ã€‚

è®©æˆ‘ä»¬è¿”å›ç¼–è¾‘å™¨ï¼šä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥é€šè¿‡å·¦ä¾§å¯¼èˆªèœå•è½¬åˆ° "æ¦‚è¿°" é€‰é¡¹å¡ï¼Œç„¶åæŒ‰ "æ‰“å¼€ Playground"ã€‚æˆ‘ä»¬å…ˆä½¿ç”¨ `Deno.serve()` æ¥å¤„ç† HTTP è¯·æ±‚ï¼š

```ts
Deno.serve(async (req) => {
  return new Response("æœªæ‰¾åˆ°", { status: 404 });
});
```

æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ <kbd>Ctrl</kbd>+<kbd>S</kbd> ï¼ˆæˆ– Mac ä¸Šçš„ <kbd>Cmd</kbd>+<kbd>S</kbd>ï¼‰ä¿å­˜æ­¤ä»£ç ã€‚æ‚¨åº”è¯¥çœ‹åˆ°å³ä¾§çš„é¢„è§ˆé¡µé¢è‡ªåŠ¨åˆ·æ–°ï¼šç°åœ¨æ˜¾ç¤º "æœªæ‰¾åˆ°"ã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å¯¼å…¥ Postgres æ¨¡å—ï¼Œä»ç¯å¢ƒå˜é‡ä¸­è¯»å–è¿æ¥å­—ç¬¦ä¸²ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ã€‚

```ts
import * as postgres from "https://deno.land/x/postgres@v0.14.0/mod.ts";

// ä»ç¯å¢ƒå˜é‡ "DATABASE_URL" è·å–è¿æ¥å­—ç¬¦ä¸²
const databaseUrl = Deno.env.get("DATABASE_URL")!;

// åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰ä¸‰ä¸ªè¿æ¥çš„æ•°æ®åº“æ± ï¼Œè¿™äº›è¿æ¥ä¼šåœ¨ä½¿ç”¨æ—¶å»ºç«‹
const pool = new postgres.Pool(databaseUrl, 3, true);
```

åŒæ ·ï¼Œæ‚¨ç°åœ¨å¯ä»¥ä¿å­˜æ­¤ä»£ç ï¼Œä½†è¿™æ¬¡æ‚¨åº”è¯¥ä¸ä¼šçœ‹åˆ°ä»»ä½•å˜åŒ–ã€‚æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬è¿˜æ²¡æœ‰å¯¹æ•°æ®åº“æ‰§è¡Œä»»ä½•æŸ¥è¯¢ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®è¡¨æ¨¡å¼ã€‚

æˆ‘ä»¬æƒ³è¦å­˜å‚¨å¾…åŠäº‹é¡¹çš„åˆ—è¡¨ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º `todos` çš„è¡¨ï¼ŒåŒ…å«ä¸€ä¸ªè‡ªå¢çš„ `id` åˆ—å’Œä¸€ä¸ª `title` åˆ—ï¼š

```ts
const pool = new postgres.Pool(databaseUrl, 3, true);

// è¿æ¥åˆ°æ•°æ®åº“
const connection = await pool.connect();
try {
  // åˆ›å»ºè¡¨
  await connection.queryObject`
    CREATE TABLE IF NOT EXISTS todos (
      id SERIAL PRIMARY KEY,
      title TEXT NOT NULL
    )
  `;
} finally {
  // å°†è¿æ¥é‡Šæ”¾å›è¿æ¥æ± 
  connection.release();
}
```

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªè¡¨ï¼Œå¯ä»¥ä¸º GET å’Œ POST ç«¯ç‚¹æ·»åŠ  HTTP å¤„ç†ç¨‹åºã€‚

```ts
Deno.serve(async (req) => {
  // è§£æ URL å¹¶æ£€æŸ¥è¯·æ±‚çš„ç«¯ç‚¹æ˜¯å¦ä¸º /todosã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿”å› 404 å“åº”ã€‚
  const url = new URL(req.url);
  if (url.pathname !== "/todos") {
    return new Response("æœªæ‰¾åˆ°", { status: 404 });
  }

  // ä»æ•°æ®åº“æ± ä¸­è·å–ä¸€ä¸ªè¿æ¥
  const connection = await pool.connect();

  try {
    switch (req.method) {
      case "GET": { // è¿™æ˜¯ä¸€ä¸ª GET è¯·æ±‚ã€‚è¿”å›æ‰€æœ‰å¾…åŠäº‹é¡¹çš„åˆ—è¡¨ã€‚
        // æ‰§è¡ŒæŸ¥è¯¢
        const result = await connection.queryObject`
          SELECT * FROM todos
        `;

        // å°†ç»“æœç¼–ç ä¸º JSON
        const body = JSON.stringify(result.rows, null, 2);

        // ä»¥ JSON æ ¼å¼è¿”å›ç»“æœ
        return new Response(body, {
          headers: { "content-type": "application/json" },
        });
      }
      case "POST": { // è¿™æ˜¯ä¸€ä¸ª POST è¯·æ±‚ã€‚åˆ›å»ºä¸€ä¸ªæ–°çš„å¾…åŠäº‹é¡¹ã€‚
        // å°†è¯·æ±‚ä½“è§£æä¸º JSONã€‚å¦‚æœè¯·æ±‚ä½“è§£æå¤±è´¥ã€ä¸æ˜¯å­—ç¬¦ä¸²æˆ–è¶…è¿‡ 256 ä¸ªå­—ç¬¦ï¼Œè¿”å› 400 å“åº”ã€‚
        const title = await req.json().catch(() => null);
        if (typeof title !== "string" || title.length > 256) {
          return new Response("è¯·æ±‚é”™è¯¯", { status: 400 });
        }

        // å°†æ–°çš„å¾…åŠäº‹é¡¹æ’å…¥æ•°æ®åº“
        await connection.queryObject`
          INSERT INTO todos (title) VALUES (${title})
        `;

        // è¿”å› 201 åˆ›å»ºå“åº”
        return new Response("", { status: 201 });
      }
      default: // å¦‚æœæ—¢ä¸æ˜¯ POST ä¹Ÿä¸æ˜¯ GETï¼Œåˆ™è¿”å› 405 å“åº”ã€‚
        return new Response("ä¸å…è®¸çš„æ–¹æ³•", { status: 405 });
    }
  } catch (err) {
    console.error(err);
    // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¿”å› 500 å“åº”
    return new Response(`å†…éƒ¨æœåŠ¡å™¨é”™è¯¯\n\n${err.message}`, {
      status: 500,
    });
  } finally {
    // å°†è¿æ¥é‡Šæ”¾å›è¿æ¥æ± 
    connection.release();
  }
});
```

å°±è¿™æ · - åº”ç”¨ç¨‹åºå®Œæˆäº†ã€‚é€šè¿‡ä¿å­˜ç¼–è¾‘å™¨æ¥éƒ¨ç½²æ­¤ä»£ç ã€‚æ‚¨ç°åœ¨å¯ä»¥å‘ `/todos` ç«¯ç‚¹å‘é€ POST è¯·æ±‚ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¾…åŠäº‹é¡¹ï¼Œå¯ä»¥é€šè¿‡å‘ `/todos` å‘é€ GET è¯·æ±‚æ¥è·å–æ‰€æœ‰å¾…åŠäº‹é¡¹çš„åˆ—è¡¨ï¼š

```sh
$ curl -X GET https://tutorial-postgres.deno.dev/todos
[]â

$ curl -X POST -d '"ä¹°ç‰›å¥¶"' https://tutorial-postgres.deno.dev/todos

$ curl -X GET https://tutorial-postgres.deno.dev/todos
[
  {
    "id": 1,
    "title": "ä¹°ç‰›å¥¶"
  }
]â
```

ä¸€åˆ‡æ­£å¸¸ ğŸ‰

æœ¬æ•™ç¨‹çš„å®Œæ•´ä»£ç ï¼š

<iframe width="100%" height="600" src="https://embed.deno.com/playground/tutorial-postgres?layout=code-only&corp"></iframe>

ä½œä¸ºé¢å¤–çš„æŒ‘æˆ˜ï¼Œå°è¯•æ·»åŠ ä¸€ä¸ª `DELETE /todos/:id` ç«¯ç‚¹æ¥åˆ é™¤å¾…åŠäº‹é¡¹ã€‚[URLPattern][urlpattern] API å¯ä»¥å¸®åŠ©æ‚¨å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚

[urlpattern]: https://developer.mozilla.org/en-US/docs/Web/API/URL_Pattern_API