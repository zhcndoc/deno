---
title: 数据库
description: 连接到外部数据库实例，无缝集成您的应用程序及其环境。
---

:::info

您正在查看 Deno Deploy<sup>EA</sup> 的文档。寻找 Deploy Classic 文档？[请点击这里](/deploy/)。

:::

数据库功能允许您将应用程序连接到外部数据库服务器。当您为应用分配数据库时，Deno Deploy 会自动为每个部署环境（生产环境、Git 分支和预览时间线）配置独立的数据库。

您的代码会自动连接到每个环境对应的正确数据库，无需手动检测时间线或处理数据库名称。只需使用您喜爱的数据库驱动程序进行连接——Deno Deploy 会通过环境变量自动处理连接细节。

## 入门指南

### 添加数据库

导航到您的组织仪表板，点击导航栏中的“数据库”。点击“添加数据库”并选择您的数据库引擎——目前支持 PostgreSQL，其他引擎计划在后续版本中支持。

您可以手动输入连接详情，或粘贴连接字符串以自动填充表单。连接详情包括数据库服务器主机名、端口（PostgreSQL 通常为 5432）、用户名、密码，以及（可选）所需的 SSL 证书。

保存前，请使用“测试连接”按钮验证您的设置是否有效。修复任何连接问题后，为您的数据库实例指定一个易记名称，然后点击“保存”完成创建。

#### 使用连接字符串

无需填写单个字段，您可以粘贴类似 `postgresql://username:password@hostname:port/database` 的连接字符串来自动填充表单字段。

**常见格式：**

- PostgreSQL：`postgresql://user:pass@localhost:5432/dbname` 或 `postgres://user:pass@localhost:5432/dbname`

### 将应用连接到数据库

创建数据库实例后，您可以将其分配给应用。在数据库列表中，点击目标数据库旁的“分配”，然后从下拉菜单中选择应用。

Deno Deploy 会自动为每个时间线创建独立的数据库：

- 生产环境部署使用 `{app-id}-production`
- Git 分支使用 `{app-id}--{branch-name}`
- 预览部署使用 `{app-id}-preview`

这确保您的生产数据在开发和测试过程中保持安全。您可以监控配置过程，查看状态变为“已连接”。如有任何错误，使用“修复”按钮重试。

## 在代码中使用数据库

### 无需配置

将数据库分配给应用后，从代码中连接数据库非常简单。您无需配置连接字符串、设置环境变量或管理凭据——Deno Deploy 会自动处理所有这些工作。

只需像往常一样使用您喜爱的数据库库，它会自动连接到当前环境的正确数据库。

### 自动环境变量

Deno Deploy 会自动将标准数据库环境变量注入应用的运行时环境。对于 PostgreSQL，这些变量包括 `PGHOST`、`PGPORT`、`PGDATABASE`（自动为您的环境选择）、`PGUSER`、`PGPASSWORD` 和 `PGSSLMODE`。这些变量遵循标准约定，因此大多数数据库库会自动检测并使用它们，无需任何配置。

### PostgreSQL 示例

以下是在 Deno Deploy 应用中连接 PostgreSQL 的方法：

```typescript
import { Pool } from "npm:pg";

// 无需配置——Deno Deploy 会自动处理
const pool = new Pool();

Deno.serve(() => {
  // 使用数据库
  const result = await pool.query("SELECT * FROM users WHERE id = $1", [123]);

  return new Response(JSON.stringify(result.rows), {
    headers: { "content-type": "application/json" },
  });
});
```

### 工作原理

Deno Deploy 会自动检测您的代码运行在哪个环境（生产、Git 分支或预览），然后根据该环境选择相应的数据库。正确的连接详情会自动设置为环境变量，您的数据库库会自动读取这些标准环境变量。

您的代码在所有环境中以相同方式运行，但连接到不同的数据库。相同的 `new Pool()` 代码在生产环境中连接到 `myappid-production`，在 Git 分支中连接到 `myappid--branch-name`，在预览环境中连接到 `myappid-preview`。

### 迁移和 schema 管理

由于每个环境都有自己的数据库，您可以在 Git 分支中安全地测试迁移，而不会影响生产环境或其他分支特定的数据库。

```typescript
// 为当前环境的数据库运行迁移
import { Pool } from "npm:pg";

const pool = new Pool();

// 这会针对每个环境的正确数据库运行
await pool.query(`
  CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100)
  )
`);
```

### 本地开发

本地开发时，您可以使用本地 PostgreSQL 实例（通过包管理器安装 PostgreSQL 或从 postgresql.org 下载），或连接到远程数据库服务器。

在项目根目录中创建 `.env` 文件（如果尚未存在），并添加 PostgreSQL 连接详情：

```bash
PGHOST=localhost        # 或您的远程主机
PGPORT=5432
PGDATABASE=myapp_dev
PGUSER=myuser
PGPASSWORD=mypassword
PGSSLMODE=prefer        # 远程连接使用 `require`
```

然后使用 `--env` 标志运行应用程序，自动加载这些环境变量：

```bash
deno run --env --allow-all main.ts
```

您的应用程序代码保持不变——本地开发期间，它会自动使用这些环境变量连接到您选择的数据库。

## SSL 配置

所有数据库连接均使用 SSL 加密以确保安全。主要区别在于根据数据库提供商的不同，证书的处理方式也不同。

### 证书类型

**受信任的根 CA 证书：** 有些数据库提供商使用由受信任的根证书颁发机构（如 Let's Encrypt 或 DigiCert）签名的证书。这些证书无需任何配置即可自动工作。

**私有根 CA 证书：** 有些提供商使用自签名证书或私有证书颁发机构。在这种情况下，您需要上传用于签名数据库证书的 CA 证书。

### 证书配置

**对于使用受信任根 CA 证书的数据库：** 无需上传证书，SSL 连接会自动工作。一些托管数据库服务属于此类。

**对于使用私有根 CA 证书的数据库：** AWS RDS 用户可以点击“使用 AWS 证书包”自动配置 AWS RDS 证书，无需从 AWS 文档中下载。其他提供商要求您上传数据库提供商提供的特定 CA 证书。

### 常见提供商

**AWS RDS** 使用 AWS 自己的证书颁发机构（未公开信任）。点击“使用 AWS 证书包”可自动配置，无需从 AWS 文档中手动下载证书。

**Google Cloud SQL** 使用 Google 自己的证书颁发机构（未公开信任）。您需要上传 Google Cloud SQL CA 证书，可从 Google Cloud 控制台下载。

**自托管数据库** 如果使用自签名证书，需要上传自定义 CA 证书，或者您可以配置数据库使用公开信任的 CA 证书。

## 数据库管理

### 查看数据库详情

点击任何数据库实例，查看连接信息（主机名、端口、引擎类型）、已分配的应用、实例中创建的各个数据库，以及整体健康状况和连接状态。

### 数据库状态指示

仪表板显示清晰的状态指示：

- **🟢 已连接** - 所有数据库就绪并正常工作
- **🟡 创建中** - 数据库正在配置中
- **🔴 错误** - 部分数据库创建失败
- **⚪ 未分配** - 此数据库尚未被任何应用使用

### 管理应用分配

要将数据库分配给应用，点击数据库实例上的“分配”，从下拉菜单中选择应用，然后确认分配。要从数据库中移除应用，进入数据库详情页，在“已分配应用”表格中找到该应用，然后点击应用旁的“移除”。

### 编辑数据库设置

点击任何数据库实例上的“编辑”以更新连接详情。保存前测试连接以确保其仍然有效。

## 支持的数据库引擎

**当前支持：** PostgreSQL 完全支持所有功能。

**即将支持：** MySQL、MongoDB、Redis 等计划在未来版本中支持。

## 故障排除

### 连接问题

**“连接失败”错误** 通常表示：

- 主机名和端口不正确
- 用户名和密码错误
- 数据库服务器未运行
- 网络连接问题

验证所有连接详情，确保数据库服务器可访问。

**“权限被拒绝”错误** 意味着数据库用户缺少必要的权限。验证数据库用户具有所需的权限，可以创建数据库，并且可以从 Deno Deploy 的服务器连接。

**SSL 连接问题** 发生在：

- 数据库实例使用受信任的根 CA，但数据库服务器上的 SSL 连接配置不正确
- 数据库实例使用私有根 CA，但未上传正确的 CA 证书
- 数据库服务器不支持 SSL 连接
- 证书已过期

检查数据库服务器的 SSL 配置和证书有效性。

### 配置问题

**“数据库创建失败”** 通常表示：

- 数据库用户缺少 CREATE 权限
- 磁盘空间不足
- 与现有数据库存在命名冲突

检查数据库用户权限和服务器容量。

**“超时”错误** 表明：

- Deno Deploy 与数据库服务器之间存在网络连接问题
- 数据库服务器响应缓慢

检查服务器负载和性能。

**“错误”状态** 可以通过以下方式解决：

- 使用“修复”按钮重试失败的操作
- 检查数据库服务器日志以获取更详细的信息

## 常见问题

**问：多个应用可以共享同一个数据库实例吗？**

是的！多个应用可以分配到同一个数据库实例。每个应用在该实例中获得自己的隔离数据库。

**问：移除应用分配后，我的数据会发生什么？**

数据库仍保留在您的数据库服务器上。仅移除应用与数据库实例之间的连接。

**问：我可以为多个环境使用同一个数据库吗？**

默认情况下，每个环境（生产、分支、预览）都有自己的数据库，以确保隔离并防止数据冲突。但是，您可以使用数据库库中的选项自定义代码连接的数据库。

**问：如何直接访问我的数据库？**

您可以使用提供的连接详情直接连接到数据库服务器。使用 Deno Deploy 仪表板中显示的数据库名称。

**问：我可以更改数据库连接详情吗？**

是的，点击任何数据库实例上的“编辑”以更新连接详情。保存前测试连接以确保其有效。

**问：如何删除数据库实例？**

首先移除所有应用分配，然后点击数据库实例上的“删除”。这只会移除 Deno Deploy 中的连接——您实际的数据库服务器不受影响。
