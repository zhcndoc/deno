---
title: 构建
---

:::info

您正在查看 Deno Deploy<sup>EA</sup> 的文档。想查找 Deploy Classic 文档？[点击这里查看](/deploy/)。

:::

在 Deno Deploy<sup>EA</sup> 中，一个应用的代码可以有多个历史版本。这些版本（或构建）通常一一对应于从 GitHub 部署时所关联的 GitHub 仓库中的 git 提交。

构建可以通过两种方式触发：

- **手动触发**，通过构建页面上的“部署默认分支”按钮。默认情况下，这将触发对“默认” git 分支（通常是 `main`）的构建。该页面上按钮的下拉菜单可以用来选择其他分支进行部署。
- **自动触发**，每当一个新的提交推送到关联到该应用的 GitHub 仓库时自动触发构建。

一个版本在最终路由并对用户可用之前，会经过多个阶段：

1. **排队：** 该版本等待被分配到构建任务。
1. **准备：** 分配一个构建器来处理构建，会将该版本的源代码下载到构建器，同时恢复任何可用的构建缓存。
1. **安装：** 如果存在安装命令，则执行安装命令。通常这会下载构建缓存中尚未包含的依赖，并检查锁文件是否是最新的。
1. **构建：** 如果存在构建命令，则执行构建命令。构建命令执行完后，会根据构建输出创建构建产物，并上传到分布式运行时基础设施。
1. **预热：** 发送一个 `GET /` 请求到该版本，检查其是否能够正确启动并监听传入的 HTTP 请求。
1. **路由：** 全局基础设施被配置以根据时间线将请求路由到新版本。

如果这些步骤中的任何一个失败，构建将进入“失败”状态。失败的构建不会接收流量。

构建日志可在仪表盘中查看。构建运行时日志会实时流式传输至仪表盘，构建完成后，构建信息仍然可以在构建页面查看。

构建缓存是一种通过重用在构建间未发生变化的文件来加速构建的方法。对于某些框架预设和 `DENO_DIR` 依赖缓存，会自动配置构建缓存。目前不支持手动将其他目录添加到缓存中。

构建运行时可以通过构建页面右上角的“取消”按钮取消。

构建最长可以运行 5 分钟，超过 5 分钟后将自动取消。

## 构建配置

构建可以通过构建配置来设置。构建配置决定了如何从源代码（存储在 GitHub 仓库）生成可部署的构建产物。

构建配置可以在以下三个位置修改：

- 创建应用时，点击“编辑构建配置”按钮
- 创建后，在应用设置中的构建配置区域点击“编辑”
- 在失败构建页面的重试抽屉中

创建应用时，如果您使用框架或常见的构建设置，构建配置可能会自动从您仓库中的文件检测出。

以下是可用的构建配置选项：

- **框架预设：** 针对部分原生支持的框架和工具的配置预设。配置框架预设后，Deno Deploy<sup>EA</sup> 会自动优化配置构建器以构建该框架。  
  [了解更多框架集成。](./frameworks/)
- **安装命令：** 用于安装依赖的 shell 命令。在含有 `package.json` 的项目中，通常是 `npm install` 或 `deno install`。不带 `package.json` 的 Deno 主导项目通常不需要，因为 Deno 可以很细粒度地安装所用依赖。
- **构建命令：** 用于构建项目的 shell 命令。通常是 `package.json` 或 `deno.json` 中定义的构建任务，可以通过 `deno task build` 或 `npm run build` 调用。
- **运行时配置：** 配置应用如何运行以提供服务。如果配置了框架预设，通常不需要显式配置，因为 Deno Deploy<sup>EA</sup> 会自动为您选择最佳策略。否则您有两种选择：
  - **动态：** 通过 Node 或 Deno 服务器动态响应每个请求的应用。常见于 API 服务器（如 Express、Hono 等）或服务端渲染网站（如 Fresh）。
    - 对于动态应用，必须配置 **入口文件**。这是运行 `deno run` 或 `node` 时传入执行的 JavaScript 或 TypeScript 文件。
    - 可以选择性配置传给应用的 **参数**，入口文件之后的参数，应用可通过 `Deno.args` 或 `process.args` 访问。
  - **静态：** 提供相同（预渲染）内容给所有用户的静态网站。常见于静态站点生成器（如 Lume、11ty 等）和单页应用（如 Vite React 模板、create-react-app）。
    - 对于静态应用，必须配置包含静态资源的 **目录**，如 `_dist`、`.output` 或 `site`。
    - 可选择开启 **单页应用** 模式，非静态文件请求时返回根目录下的 `index.html`，而非 404 状态码。

## 构建环境

构建环境是基于 Linux 的环境，运行在 x64 或 ARM64 架构上。构建环境中可用的工具包括：

- `deno`（版本与运行时相同）
- `npm`
- `yarn`
- `pnpm`
- `git`
- `tar`
- `gzip`