---
title: 构建
description: "Deno Deploy 早期访问版中的构建流程详细说明，涵盖构建触发方式、阶段、配置选项、缓存以及构建环境。"
---

:::info

您正在查看 Deno Deploy<sup>EA</sup> 的文档。想查找 Deploy Classic 文档？[点击这里查看](/deploy/)。

:::

在 Deno Deploy<sup>EA</sup> 中，应用的代码可以有多个历史版本。这些版本（或称构建）通常与来自 GitHub 关联仓库的 git 提交一一对应，当从 GitHub 部署时即为如此。

构建可以通过两种方式触发：

- **手动触发**，使用构建页面上的“部署默认分支”按钮。默认情况下，这将触发对“默认” git 分支（通常是 `main`）的构建。此页面该按钮的下拉菜单可用以选择其他分支进行部署。
- **自动触发**，每当向关联的 GitHub 仓库推送新提交时，都会自动触发构建。

一个版本在最终路由并可供用户访问前会经过多个阶段：

1. **排队中：**该版本正在等待分配构建任务。
2. **准备中：**分配给该构建的构建器开始任务，下载该版本的源代码到构建器，并恢复任何可用的构建缓存至构建器。
3. **安装：**执行安装命令（如果存在）。通常会下载任何尚未包含在构建缓存中的依赖，并检查锁文件是否最新。
4. **构建：**执行构建命令（如果存在）。构建命令执行完后，从构建输出创建构建产物，并上传到分布式运行时基础设施。
5. **预热：**发送 `GET /` 请求到该版本，检查其是否成功启动并开始监听入站 HTTP 请求。
6. **路由：**根据时间线配置全局基础设施，将请求路由至新版本。

如果任一阶段失败，构建状态将变为“失败”。失败的构建不会接收流量。

构建日志可在控制面板查看。构建运行时，日志会实时流式传输至控制面板。构建结束后，构建记录仍可在构建页面访问。

构建缓存通过重用未改变的文件来加快构建速度。部分框架预设和 `DENO_DIR` 依赖缓存会自动配置缓存。目前无法手动添加其他目录至缓存。

构建进行时，可以通过构建页面右上角的“取消”按钮终止构建。

构建最长运行时间为 5 分钟，超过该时长构建将被自动取消。

## 构建配置

构建可通过构建配置进行管理。构建配置决定如何从存储于 GitHub 仓库的源代码，生成可部署的构建产物。

构建配置可在三个地方进行修改：

- 创建应用时，点击“编辑构建配置”按钮
- 创建后，在应用设置的构建配置部分点击“编辑”
- 在失败构建页面的重试面板中

创建应用时，如果使用的是框架或常见构建设置，构建配置可能会根据仓库中检测到的文件自动生成。

以下是可用的构建配置选项：

- **框架预设：**针对某些原生支持的框架和工具的配置预设。配置框架预设后，Deno Deploy<sup>EA</sup> 会自动为构建器配置最优的构建方案。[了解框架集成详细信息](./frameworks/)。
- **安装命令：**执行安装依赖的 shell 命令。在带有 `package.json` 的项目中，通常是 `npm install` 或 `deno install`。在无 `package.json` 的 Deno 优先项目中，常不需要此操作，因为 Deno 能够细粒度安装仅使用到的依赖。
- **构建命令：**执行构建项目的 shell 命令。通常是 `package.json` 或 `deno.json` 定义的构建任务，可通过 `deno task build` 或 `npm run build` 调用。
- **运行时配置：**应用的运行配置，用于提供服务。如果设置了框架预设，通常不需手动配置，因为 Deno Deploy<sup>EA</sup> 会自动为您挑选最佳方案。否则您有两种选择：
  - **动态：**使用 Node 或 Deno 服务器动态响应每个请求的应用。例如 API 服务器（Express、Hono 等）或服务端渲染网站（如 Fresh）。
    - 动态应用必须配置**入口点**，这是您用 `deno run` 或 `node` 执行的 JavaScript 或 TypeScript 文件。
    - 可以选择配置作为入口点后传递给应用的**参数**，可通过 `Deno.args` 或 `process.args` 在应用中访问。
  - **静态：**提供相同（预渲染）内容给所有用户的静态网站，例如静态站点生成器（Lume、11ty 等）和单页应用（例如 Vite React 模板、create-react-app）。
    - 静态应用必须配置包含静态资源的**目录**，如 `_dist`、`.output` 或 `site`。
    - 可以选择启用**单页应用（SPA）**模式，此模式将所有不匹配静态文件的请求返回根目录的 `index.html` ，而非 404 状态码。

## 构建环境

构建环境基于 Linux，运行在 x64 或 ARM64 架构上。构建环境内包含以下工具：

- `deno`（与运行时版本相同）
- `node`
- `npm`
- `npx`
- `yarn`（v1）
- `pnpm`
- `git`
- `tar`
- `gzip`

:::info

构建器内部所有 JavaScript 均使用 Deno 执行。

因此，构建环境中的 `node` 并非真正 Node.js，而是一个将 Node.js 调用转换为 `deno run` 的 shim。`npm`、`npx`、`yarn` 和 `pnpm` 也都是在 Deno 环境下运行的，而非原生 Node.js。

:::

在组织或应用设置中，为“构建”上下文配置的环境变量会在构建环境中生效。仅在“生产”或“开发”上下文中可用的环境变量不会在构建环境中生效。[了解更多关于环境变量](./env-vars-and-contexts/)。

构建过程中，构建器提供 8 GB 存储空间。