---
title: 运行时
description: "关于 Deno Deploy 早期访问运行时环境的详细信息，包括应用程序生命周期、启动、关闭和冷启动优化."
---

:::info

您正在查看 Deno Deploy<sup>EA</sup> 的文档。 查找 Deploy Classic 的文档？[点击这里查看](/deploy/)。

:::

在 Deno Deploy<sup>EA</sup>中，所有应用程序均在安全隔离的 Linux 环境中使用标准的 Deno 运行时执行。

Deno Deploy<sup>EA</sup> 使用的 Deno 运行时是标准的 Deno 运行时，支持所有 Deno CLI 的功能，包括 JSR 和 NPM 依赖项，读写文件系统，进行网络请求，生成子进程，以及加载 FFI 和节点原生插件。

Deno 运行时以 `--allow-all` 权限运行。

不能向 Deno 运行时传递自定义标志。

## 运行环境

运行环境是基于 Linux 的环境，运行在 x64 或 ARM64 架构上。可用工具的具体集合可能会发生变化，因此无法保证其稳定。

目前，Deno Deploy<sup>EA</sup> 运行在 Deno 2.3.2 版本。

## 生命周期

Deno Deploy<sup>EA</sup> 以无服务器环境运行应用程序。这意味着应用程序并非一直运行，只有在收到请求时才会启动。当一段时间内没有传入流量时，应用程序会被停止。

应用程序可以随时启动和停止。因此，它们也应当能够快速启动，以响应传入请求而不产生延迟。

相同的应用程序的多个实例可以同时运行。例如，一个实例可以在美国运行，另一个在欧洲。每个实例彼此完全隔离，不共享任何 CPU、内存或磁盘资源。如有需要，也可以在同一区域启动多个实例，例如以应对高流量或在基础设施升级时。

### 启动

当系统决定启动应用程序时，会为其分配一个新的沙箱环境运行。该环境与其他所有应用程序隔离。

然后，系统会使用配置的入口点启动应用程序，并等待 HTTP 服务器启动。如果应用程序在 HTTP 服务器启动之前崩溃，触发启动的请求将返回 502 Bad Gateway 错误。

一旦应用程序启动，传入请求会被路由到它，并由其响应。

### 关闭

应用程序会一直保持运行，直到没有新的传入请求，或者在一段时间内没有响应（或响应体字节）被发送。具体的超时时间在 5 秒到 10 分钟之间。活跃传输数据的 WebSocket 连接（包括 ping/pong 帧）也会保持应用程序的运行。

当系统决定停止应用程序时，会向应用发送 `SIGINT` 信号以触发关机。从此时起，应用有 5 秒时间进行优雅关闭，否则将被强制使用 `SIGKILL` 信号终止。

### 移除

有时即使应用仍在接收流量，也可能会关闭某个隔离实例。发生这种情况的例子包括：

- 应用程序曾经扩展以应对负载，但负载已下降到可以由单个实例处理的程度。
- 执行实例的底层服务器资源有限，无法继续运行该实例。
- 底层基础设施正在进行更新或遇到故障。

当系统决定移除某个应用时，会尽早尝试将流量从被移除的实例转向其他实例。有时这意味着请求会被暂缓，等待新实例启动，即使已有实例正在运行。

对于只响应短时间请求的应用，通常不会注意到实例的被移除。对于处理长时间请求或者 WebSocket 的应用，可能会更明显，因为可能在请求仍在处理时实例被移除。系统会尽量避免这种情况，但并非总能做到。

在流量被转移出去后，系统会向旧实例发送 `SIGINT` 信号，触发优雅关机。应用应尽快完成剩余请求，关闭 WebSocket 和其他长连接。发起长时间请求的客户端应做好应对断开连接的准备，并在断开后重新连接。

在 `SIGINT` 信号发出后 5 秒，旧实例如果还未优雅关闭，将被强制用 `SIGKILL` 信号终止。

## 冷启动

由于应用并不总是在运行，因此在收到请求时可能需要启动应用。这称为冷启动。在 Deno Deploy<sup>EA</sup> 中，冷启动经过高度优化，对于简单的“hello world”应用，能在 100 毫秒内完成，对于较大应用，也只需几百毫秒。

Deno Deploy<sup>EA</sup> 采用多项优化措施以实现快速冷启动：

- 沙箱和 Deno 运行时预先配置，确保无需从零开始配置即可启动应用。
- 当客户端发送第一包 TCP 数据以建立 TLS 连接时，即可立即启动应用。对于启动快速的应用程序，并且根据用户网络的往返延迟，这可能意味着应用在客户端还未发出 HTTP 请求时就已启动。
- 文件系统访问已针对在启动期间频繁使用的文件进行了优化。Deno Deploy<sup>EA</sup> 在预热阶段分析文件访问模式，并优化文件系统以加快访问速度。

当冷启动较慢时，会给用户带来明显延迟。因此，优化应用程序以实现快速启动非常重要。以下是一些优化冷启动的建议：

1. 最小化应用程序使用的依赖项数量。

2. 使用动态 `import()` 按需加载不经常访问的代码和依赖项。

3. 尽量减少启动期间的 I/O 操作，例如避免大量顶层 `await` 和网络请求。

如果你觉得你的应用启动慢，请[联系 Deno 支持](../support)，我们将协助你排查问题。